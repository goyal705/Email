<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Welcome Page</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f4f4f4;
      }
      .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #4caf50;
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
      }
      .logout-btn {
        background-color: #f44336;
        border: none;
        color: white;
        padding: 8px 15px;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.3s;
      }
      .logout-btn:hover {
        background-color: #d32f2f;
      }
      .container {
        max-width: 1200px;
        margin: 20px auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        text-align: center;
        color: #333;
      }
      .tabs {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }
      .tab-button {
        background: #ddd;
        border: none;
        padding: 10px 20px;
        cursor: pointer;
        margin: 0 5px;
        border-radius: 4px;
        transition: background 0.3s;
      }
      .tab-button.active {
        background: #4caf50;
        color: white;
      }
      .tab-button:hover {
        background: #bbb;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .tab-content p {
        padding: 20px;
        text-align: center;
      }
      @media (max-width: 600px) {
        .tabs {
          flex-direction: column;
          align-items: center;
        }
        .tab-button {
          width: 100%;
          margin: 5px 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="top-bar">
      <div>Welcome, {{ user_name }}</div>
      <form action="/logout" method="get">
        <button type="submit" class="logout-btn">Logout</button>
      </form>
    </div>

    <div class="container">
      <div class="tabs">
        <button class="tab-button active" onclick="openTab(event, 'companies')">
          View My Companies
        </button>
        <button class="tab-button" onclick="openTab(event, 'mail')">
          Schedule Mails
        </button>
        <button class="tab-button" onclick="openTab(event, 'profile')">
          Update Profile
        </button>
        <button class="tab-button" onclick="openTab(event, 'add-company')">
          Add Company
        </button>
      </div>
      <div id="companies" class="tab-content active">
        <h2>Registered Companies</h2>
        <table
          id="companies-table"
          border="1"
          style="width: 100%; border-collapse: collapse"
        >
          <thead>
            <tr>
              <th>ID</th>
              <th>HR Name</th>
              <th>Email</th>
              <th>Company Name</th>
              <th>Mail Sent</th>
              <th>Added By (User Name)</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="companies-body"></tbody>
        </table>
        <div id="pagination"></div>
      </div>
      <div id="mail" class="tab-content">
        <div id="mail-form-container">
          <p>Loading mail form...</p>
        </div>
      </div>
      <div id="profile" class="tab-content">
        <div id="profile-form-container">
          <p>Loading profile form...</p>
        </div>
      </div>
      <div id="add-company" class="tab-content">
        <div id="company-form-container">
          <p>Loading company registration form...</p>
        </div>
      </div>
    </div>
    <script>
      async function loadCompanies(page = 1) {
        try {
          const response = await fetch(`/my_companies?page=${page}`);
          const html = await response.text();
          document.getElementById("companies-body").innerHTML = html;
        } catch (error) {
          document.getElementById("companies-body").innerHTML =
            "<tr><td colspan='5'>Failed to load companies.</td></tr>";
        }
      }

      function openTab(evt, tabName) {
        var tabcontent = document.getElementsByClassName("tab-content");
        for (let i = 0; i < tabcontent.length; i++) {
          tabcontent[i].style.display = "none";
        }

        var tabbuttons = document.getElementsByClassName("tab-button");
        for (let i = 0; i < tabbuttons.length; i++) {
          tabbuttons[i].className = tabbuttons[i].className.replace(
            " active",
            ""
          );
        }

        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";

        if (tabName === "profile") {
          fetch("/updateprofile")
            .then((response) => response.text())
            .then((html) => {
              document.getElementById("profile-form-container").innerHTML =
                html;
            })
            .catch(() => {
              document.getElementById("profile-form-container").innerHTML =
                "<p>Failed to load form.</p>";
            });
        } else if (tabName === "add-company") {
          fetch("/company_registration")
            .then((response) => response.text())
            .then((html) => {
              document.getElementById("company-form-container").innerHTML =
                html;
            })
            .catch(() => {
              document.getElementById("company-form-container").innerHTML =
                "<p>Failed to load form.</p>";
            });
        }
      }

      window.addEventListener("load", () => {
        loadCompanies();
      });
    </script>
    <script>
      async function sendMail(id) {
        const response = await fetch(`/send_mail/${id}`, {
          method: "POST",
        });
        const data = await response.json();

        alert(data.message || data.error);
        loadCompanies(); // reload the list after deletion
      }
      async function deleteCompany(id) {
        if (!confirm("Are you sure you want to delete this company?")) return;

        const response = await fetch(`/delete_company/${id}`, {
          method: "POST",
        });
        const data = await response.json();

        alert(data.message || data.error);
        loadCompanies(); // reload the list after deletion
      }

      async function editCompany(id) {
        const hr_name = prompt("Enter new HR Name:");
        const email = prompt("Enter new Email:");
        const company_name = prompt("Enter new Company Name:");

        if (!hr_name || !email || !company_name) {
          alert("All fields are required!");
          return;
        }

        const formData = new FormData();
        formData.append("hr_name", hr_name);
        formData.append("email", email);
        formData.append("company_name", company_name);

        const response = await fetch(`/edit_company/${id}`, {
          method: "POST",
          body: formData,
        });

        const data = await response.json();
        alert(data.message || data.error);
        loadCompanies(); // reload updated data
      }
    </script>
  </body>
</html>
